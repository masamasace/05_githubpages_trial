<!DOCTYPE html>
<html>

<head>
    <title>JRAPID Golbasi</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        #map-container {
            display: flex;
            justify-content: center;
        }

        #map {
            max-width: 800px;
            width: 100%;
            height: 600px;
        }

        #data-links {
            margin-top: 20px;
            padding: 10px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-width: 800px;
            margin: 20px auto;
        }

        #data-links h2 {
            color: #202020;
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        #data-links ul {
            list-style-type: none;
            padding: 0;
        }

        #data-links li {
            margin: 10px 0;
        }

        #data-links a {
            text-decoration: none;
            color: #007bff;
            font-weight: bold;
        }

        #data-links a:hover {
            text-decoration: underline;
        }

        #plot {
            width: 100%;
            height: 500px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
    </style>
</head>

<body>
    <div id="map-container">
        <div id="map"></div>
    </div>
    <div id="data-links">
        <h2>Overview</h2>
        <p>This map shows the results from the project of JSPS KAKENHI Grant Number 22K21372 and JST J-RAPID Program
            Grant Number JPMJJR2304.</p>
        <p>The project page and downloadable dataset are available from <a
                href="https://github.com/shiga-masa/jrapid-2023-turkey-eq-golbasi">this URL</a></p>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
        const map = L.map('map').setView([37.7891366, 37.6470373], 14.5);

        const streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        const baseLayers = {
            "Streets": streets,
        };

        const overlays = {};

        function getColorMTFreq(d) {
            if (d === null || d < 0.25) return '#ff0000';
            if (d < 0.75) return '#ff8000';
            if (d < 1.25) return '#ffff00';
            if (d < 1.75) return '#80ff00';
            if (d < 2.25) return '#00ff00';
            if (d < 2.75) return '#00ff80';
            if (d < 3.25) return '#00ffff';
            return '#0000ff';
        }

        function onEachFeature(feature, layer) {
            if (feature.properties) {
                const popupContent = createPopupContent(feature.properties);
                layer.bindPopup(popupContent);
                layer.on('click', () => layer.openPopup());
                layer.on('mouseover', () => layer.openPopup());
            }
        }

        function createPopupContent(properties) {
            let popupContent = '<table>';
            const date = new Date(`${properties.start_datetime.slice(0, 4)}-${properties.start_datetime.slice(4, 6)}-${properties.start_datetime.slice(6, 8)}`);
            popupContent += `<tr><th>Date</th><td>${date.toLocaleDateString()}</td></tr>`;
            const conditionalKeys = ["group_index", "latitude", "longitude", "mean_curve_freq"];
            for (const prop of conditionalKeys) {
                if (properties[prop] !== undefined) {
                    const propLabel = prop.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    const value = prop === "mean_curve_freq" ? properties[prop].toFixed(2) :
                        (prop === "latitude" || prop === "longitude") ? properties[prop].toFixed(6) : properties[prop];
                    popupContent += `<tr><th>${prop === "mean_curve_freq" ? "Dom. Freq" : propLabel}</th><td>${value}</td></tr>`;
                }
            }
            popupContent += '</table>';
            return popupContent;
        }

        function csvToGeoJSON(csvData) {
            return {
                type: "FeatureCollection",
                features: csvData.filter(row => row.latitude && row.longitude).map(row => ({
                    type: "Feature",
                    properties: row,
                    geometry: {
                        type: "Point",
                        coordinates: [row.longitude, row.latitude]
                    }
                }))
            };
        }

        function pointToLayer(feature, latlng) {
            return L.circleMarker(latlng, {
                radius: 8,
                fillColor: getColorMTFreq(feature.properties['mean_curve_freq']),
                color: "#000",
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
            });
        }

        function addMicrotremorData(url, overlayName) {
            fetch(url)
                .then(response => response.text())
                .then(csvText => {
                    Papa.parse(csvText, {
                        header: true,
                        dynamicTyping: true,
                        complete: function (results) {
                            const geojson = csvToGeoJSON(results.data);
                            const geoJsonLayer = L.geoJSON(geojson, {
                                pointToLayer: pointToLayer,
                                onEachFeature: onEachFeature
                            }).addTo(map);
                            overlays[overlayName] = geoJsonLayer;
                            L.control.layers(baseLayers, overlays).addTo(map);
                        }
                    });
                });
        }

        addMicrotremorData('src/microtremor/202310/group_list.csv', "Microtremor 202310");
        addMicrotremorData('src/microtremor/202406/group_list.csv', "Microtremor 202406");
    </script>
</body>

</html>
